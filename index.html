<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>TechNotes</title><meta name=keywords content="Blog,Portfolio,PaperMod"><meta name=description content="TechNotes"><meta name=author content="TechNotes"><link rel=canonical href=https://technotes.guru/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.196211a537485b3a9509ba7a77d2de5700c6d26cb8d6c95b483ea1ec528a1d43.css integrity="sha256-GWIRpTdIWzqVCbp6d9LeVwDG0my41slbSD6h7FKKHUM=" rel="preload stylesheet" as=style><link rel=icon href=https://technotes.guru/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://technotes.guru/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://technotes.guru/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://technotes.guru/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://technotes.guru/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.76.5"><link rel=alternate type=application/rss+xml href=https://technotes.guru/index.xml><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-123-45','auto');ga('send','pageview');}</script><meta property="og:title" content="TechNotes"><meta property="og:description" content="TechNotes"><meta property="og:type" content="website"><meta property="og:url" content="https://technotes.guru/"><meta property="og:site_name" content="TechNotes"><meta name=twitter:card content="summary"><meta name=twitter:title content="TechNotes"><meta name=twitter:description content="TechNotes"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","name":"TechNotes","url":"https://technotes.guru/","description":"TechNotes","thumbnailUrl":"https://technotes.guru/%3Clink%20/%20abs%20url%3E","sameAs":[]}</script></head><body class=list id=top><script>if(localStorage.getItem("pref-theme")==="dark"){document.body.classList.add('dark');}else if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}else if(window.matchMedia('(prefers-color-scheme: dark)').matches){document.body.classList.add('dark');}</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme: #1d1e20;--entry: #2e2e33;--primary: rgba(255, 255, 255, 0.84);--secondary: rgba(255, 255, 255, 0.56);--tertiary: rgba(255, 255, 255, 0.16);--content: rgba(255, 255, 255, 0.74);--hljs-bg: #2e2e33;--code-bg: #37383e;--border: #333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://technotes.guru/ accesskey=h title="TechNotes (Alt + H)">TechNotes</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://technotes.guru/categories/ title=categories><span>categories</span></a></li><li><a href=https://technotes.guru/tags/ title=tags><span>tags</span></a></li><li><a href=https://technotes.guru/about/ title=about><span>about</span></a></li></ul></nav></header><main class=main><article class="first-entry home-info"><header class=entry-header><h1>Hi there 👋</h1></header><section class=entry-content><p>Welcome to my blog</p></section><footer class=entry-footer><div class=social-icons></div></footer></article><article class=post-entry><header class=entry-header><h2>使用 Apache Spark/PySpark MinIO 分析 MovieLens 数据集</h2></header><section class=entry-content><p>MinIO
MinIO是一个用Golang开发的基于GNU Affero General Public License v3.0开源协议的高性能对象存储服务。
MinIO兼容亚马逊S3云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器/虚拟机镜像等。它可以部署在企业的内部环境中，为机器学习、分析和应用数据工作负载建立高性能的存储基础设施。
MinIO用作云原生应用程序的主要存储解决方案，可以与Kubernetes相结合，成为Hadoop生态系统中存储部分的一个有趣的替代品。
## Apache Spark / PySpark
Apache Spark 是一种用于大数据工作负载的分布式开源处理系统。它使用内存中缓存和优化的查询执行方式，可针对任何规模的数据进行快速分析查询。它提供使用 Java、Scala、Python 和 R 语言的开发 API，支持跨多个工作负载重用代码—批处理、交互式查询、实时分析、机器学习和图形处理等。
Apache Spark是用Scala编程语言编写的。PySpark的发布是为了支持Apache Spark和Python的协作，它实际上是Spark的一个Python API。此外，PySpark帮助你在Apache Spark和Python编程语言中与弹性分布式数据集（RDDs）对接。这是通过利用Py4J库实现的。Py4J是一个流行的库，它集成在PySpark中，允许python动态地与JVM对象对接。
## Jupyter Notebook
Jupyter Notebook是一个开源的WEB应用，允许用户创建和分享包含实时代码、方程式、可视化和叙述性文本的文档。其用途包括数据分析、统计建模、数据可视化、机器学习等等。Jupyter这个词是Julia、Python和R的松散缩写，不过现在Jupyter已经可以支持许多其他的编程语言。
## MovieLens 数据集
GroupLens Research从MovieLens网站（https://movielens.org）收集并提供了电影评分数据集，总共58098个电影，包含了27753444个评价和1108997个标签。
数据集下载地址： http://files.grouplens.org/datasets/movielens/ml-latest.zip
下面就主要使用这几个技术来对数据集进行简单的分析，并最终将分析结果保存的数据库中。
## 准备环境
这里使用 docker compose 部署 4 个节点的 MinIO 集群，然后通过 Nginx 进行反向代理
version: '3.7'
# Settings and configurations that are common for all containers
x-minio-common: &minio-common
image: minio/minio
command: server --console-address ":9001" http://minio{1....</p></section><footer class=entry-footer>2021-10-10&nbsp;·&nbsp;6 min&nbsp;·&nbsp;TechNotes</footer><a class=entry-link aria-label="post link to 使用 Apache Spark/PySpark MinIO 分析 MovieLens 数据集" href=https://technotes.guru/posts/2021/%E4%BD%BF%E7%94%A8-apache-spark/pyspark-minio-%E5%88%86%E6%9E%90-movielens-%E6%95%B0%E6%8D%AE%E9%9B%86/></a></article><article class=post-entry><header class=entry-header><h2>数据中台笔记</h2></header><section class=entry-content><p>数据仓库、数据湖、数据中台 数据仓库 数据湖 数据中台 数据中台的核心，是避免数据的重复计算，通过数据服务化，提高数据的共享能力，赋能数据应用。数据中台吸收了传统数据仓库、数据湖、大数据平台的优势，同时又解决了数据共享的难题，通过数据应用，实现数据价值的落地。
效率、质量和成本是决定数据能否支撑好业务的关键，构建数据中台的目标就是要实现高效率、高质量、低成本。
目前数据中台的主要应用领域还是数据智能领域，所以我们就先不延申到机器学习，深度学习，安全、推荐等领域。
实时数据中台，实现批流一体。 云上数据中台，全面拥抱K8S，实现在线、离线混合部署，进一步提高资源利用率。 智能元数据管理+增强分析，降低数据分析的门槛，进一步释放数据智能 自动化代码构建，通过拖拉拽，自动化生成ETL代码的构建，进一步释放数据研发的效能，甚至让我们的非技术人员都可以完成简单的数据加工。 数据产品的时代，面向各种行业的数据产品全面涌现，并且和中台系统联动，比如基于指标的可分析维度，自动进行指标的业务诊断等等。 数据治理 数据地图 Source of truth 数据建模 恩门建模因为是从数据源开始构建，构建成本比较高，适用于应用场景比较固定的业务，比如金融领域，冗余数据少是它的优势。
金博尔建模由于是从分析场景出发，适用于变化速度比较快的业务，比如互联网业务。由于现在的业务变化都比较快，所以我更推荐金博尔的建模设计方法。
元数据管理 开源框架
Metacat Apache Atlas 数据指标 数据服务 Data as Service
数据安全 如何解决数据误删除问题？ 如何解决敏感数据泄露问题？ 如何解决开发和生产物理隔离问题？
数据备份、恢复 热备，开启HDFS的垃圾回收站的功能 冷备 精细化权限管理 OpenLDAP + Kerberos + Ranger 实现的一体化用户、认证、权限管理体系 操作审计 数据垃圾箱设计 生产、测试开发集群物理隔离 大数据平台 大数据一体化平台</p></section><footer class=entry-footer>2021-10-10&nbsp;·&nbsp;1 min&nbsp;·&nbsp;TechNotes</footer><a class=entry-link aria-label="post link to 数据中台笔记" href=https://technotes.guru/posts/2021/%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%8F%B0%E7%AC%94%E8%AE%B0/></a></article><article class=post-entry><header class=entry-header><h2>为什么sleep会让Netty的性能大降</h2></header><section class=entry-content><p>TL;DR 即时通讯技术分享 在知乎上分享了一些列的高性能网络编程的文章，该系列文章从底层原理说起，提到了高性能网络的方方面面，特别的干货。但是在第七篇文章中， 高性能网络编程(七)：到底什么是高并发？一文即懂！ ，作者通过ab分别对Java(Netty)和PHP(Swoole)进行性能压测的部分让我产生了一些疑惑。
作者使用了ab命令分别进行了压测
ab命令：docker run --rm jordi/ab -k -c 1000 -n 1000000 http://10.234.3.32:5555/
在并发1000进行100万次Http请求的基准测试中的结果如下。
Netty的压测结果:
Swoole的压测结果:
附图直接使用了上述文章中的图片，从数据来看Netty的Requests per second为84042.11，Swoole的Requests per second的结果为87222.98，可见在默认情况下，两者的表现基本是一致的。(不过docker容器、1G内存+2核CPU，能跑出这样的QPS，还是挺意外的)
但是后来作者通过在Java和PHP代码中,分别加上 sleep(0.01) //秒 的代码，模拟0.01秒的系统调用阻塞，下面就产生了奇迹时刻：
Netty的压测结果:
Swoole的压测结果:
可以看到，Netty的QPS一下子降低到了1562.69，较原来的8万多，一下子降低了好几十倍。比起Swoole，也差了好几倍，作者也提到 “**从结果中可以看出：**基于协程的php+ swoole服务比 Java + netty服务的QPS高了6倍。” 。而且这还是0.01秒的结果，到了真实的业务系统上，实际的业务操作时间往往都超过0.01秒。
那么，是什么原因，让Netty的性能大降呢？
Netty 线程模型 首先需要了解下Netty的线程模型，那上文中的示例来说，其实际上是官方的Http中的HelloWorld示例 - HttpHelloWorldServer.java
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 public final class HttpHelloWorldServer { static final boolean SSL = System....</p></section><footer class=entry-footer>2021-03-03&nbsp;·&nbsp;2 min&nbsp;·&nbsp;TechNotes</footer><a class=entry-link aria-label="post link to 为什么sleep会让Netty的性能大降" href=https://technotes.guru/posts/2021/%E4%B8%BA%E4%BB%80%E4%B9%88sleep%E4%BC%9A%E8%AE%A9netty%E7%9A%84%E6%80%A7%E8%83%BD%E5%A4%A7%E9%99%8D/></a></article><article class=post-entry><header class=entry-header><h2>使用 github pages + issues 建立个人博客</h2></header><section class=entry-content><p>TBD - merge github actions</p></section><footer class=entry-footer>2020-10-10&nbsp;·&nbsp;1 min&nbsp;·&nbsp;TechNotes</footer><a class=entry-link aria-label="post link to 使用 github pages + issues 建立个人博客" href=https://technotes.guru/posts/2020/%E4%BD%BF%E7%94%A8-github-pages-+-issues-%E5%BB%BA%E7%AB%8B%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/></a></article><article class=post-entry><header class=entry-header><h2>服务器采购及网络存储规划</h2></header><section class=entry-content><p>服务器采购 对于需要自建（小）机房的初创公司来说，服务器采购可以说是整个IT基础设施建设的第一步，如何在“差钱”的状态下平衡服务器配置与成本的关系，就显得比较重要了。
好在现在电商发达，各种价格都比较透明，对于购买来说，最简单的就是在电商网站下单了。但是在下单之前，还是需要列一个简单的方案，比如:
在采购时比较看重哪些因素？（机架式服务器，还是塔式服务器） 通常的IT应用包括哪些? (WEB服务器，大数据套件、数据库服务、邮件服务器) 采购IT基础设施方案时最关注哪些？（易用性、可靠性，扩展能力等） 特别是在发展初期，公司规模较小，业务量不大，IT信息化建设上不会投入太多的资金，针对不同的需求，其采购的重心差别还是比较大的，特别是在发展初期，公司规模较小，业务量并不大，IT信息化建设上不会投入太多的资金，所以初期采购的时候，首先以满足初期（比如2年以内）应用为主，主要包括:
文件服务器，如FTP，文件备份，主要是对存储的需求 代码仓库服务器，跑Git服务 测试服务器 数据库服务器 尽管初创企业的业务可能变化会比较大，但是上面那么是非常基础的服务，生产环境则还是建议放到云上。比如我现在的公司，开始的时候就几个人，还是『租用』的他人的办公场所，就购买了一台塔式服务器，用于跑Gitlab，并且在上面跑了一个FTP服务。这个时候还没有专职的测试人员，也不需要发布测试版本。
大概小半年之后，租了自己的办公室，简单的隔了一个小机房，放了一个机架，这个时候人员也招聘到了将近20个。软件也大体上主要功能已经开发完成，也有了专职的测试人员。这个时候，又采购了四台联想的1U的服务器RS260, CPU E3-1220 v6 + 32G内存，配置不是很高，但是价格便宜，而且四台未来1-2年内基本上是够用的，CPU差了一些，但是日常的研发用服务器基本够了，跑个几十个应用实例基本没有压力。
processor : 1 vendor_id : GenuineIntel cpu family : 6 model : 158 model name : Intel(R) Xeon(R) CPU E3-1220 v6 @ 3.00GHz stepping : 9 microcode : 0x8e cpu MHz : 799.987 cache size : 8192 KB physical id : 0 siblings : 4 core id : 1 cpu cores : 4 apicid : 2 initial apicid : 2 fpu : yes fpu_exception : yes cpuid level : 22 wp : yes 不过，从省钱的角度, 本地服务器采用二手服务器也是一个不错的选择，可以花最少的钱办做多的事情，不过X鱼水可能比较深。我自己还是比较偏向于入二手服务器，毕竟可以花较少的资金，就可以购买到性能不错的机架服务器。...</p></section><footer class=entry-footer>2020-10-10&nbsp;·&nbsp;1 min&nbsp;·&nbsp;TechNotes</footer><a class=entry-link aria-label="post link to 服务器采购及网络存储规划" href=https://technotes.guru/posts/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%87%87%E8%B4%AD%E5%8F%8A%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8%E8%A7%84%E5%88%92/></a></article><article class=post-entry><header class=entry-header><h2>中小企业的研发体系</h2></header><section class=entry-content><p>对于中小企业，业务虽小，但五脏俱全。特别是初创公司，公司刚刚成立，人员少，主要人员还是研发人员为主，IT运维能力弱，需要部署的系统也很少，这个时候应该选择公有云或者直接使用SaaS服务，其优点非常明显： 基础IT管理交给公有云平台，对公司运维人员要求不高，基本的Linux能力就行了，如果都使用SasS的服务，甚至都不需要IT运维人员。 公有云按时按量收费，前期资金投入较少，又可以借助于公有云成熟的IT能力，企业可以将核心精力放在业务方向，专注于业务价值。同时公有云可以快速的申请资源以应业务的快速发展。 公有云提供了完善的运维、监控及流程处理等各方面的保障 公有云会通过大量的软硬件投入来完善IT安全机制，以保证每个用户的安全，这个是小企业短期内无法实现的。
使用云服务，使用云服务，使用云服务。
但是，总是有一些原因，比如从IT资产的角度，或者从数据安全的角度(比如我的数据被盗用了怎么办)，需要自己部署机房，那么就有一些列的事情需要自己处理了，包括IT基础设施及各种支撑的基础服务。
这个时候除了购买机器或者云服务器之外，需要安装部署一些列的基础服务来支持整个研发过程，包括源码仓库、中间制品仓库、CICD，已经依赖的一系列基础服务，如数据库，消息中间件服务，如消息队列服务，Redis缓存服务等等。而各种服务，还需要区分相应的环境，如开发环境，测试环境，并需要多用户支持。
在应用部署到环境之后，需要有相应的监控支持，业务监控，资源监控，性能监控等。 同时对于运行时的日志，需要提供相应的日志收集、日志处理分析的功能。同时需要相应的监控大屏以监控各个系统的SLA数据，当监控数据超过警戒线则相应的需要进行系统报警。
这个时候，整个IT运维管理，基本上就完全依赖于初期运维人员(针对初创企业，往往可能只有一个运维人员)的个人能力及经验了。
下面是是一个主要的Checklist，一部分是关于基础的IT设施，另外一部分主要是DevOps层面
基础设施 服务器采购
网络规划
存储规划
内部域名
LDAP
员工邮箱
(CMDB)
DevOps 服务器(IaaS) 虚拟化 容器化 容器化及编排 Docker (Docker Swarm) Kubernetes 代码制品仓库 Git JForg Nexus Docker Registry CI/CD Jenkins 部署pipeline GitOps 中间件服务 Redis Kafka Message Queue 数据库 MySQL MongoDB ElasticSearch 存储服务 云存储服务 自建存储服务 效能 任务管理 Bug系统 内部沟通(如Slack) Wiki 代码质量分析 Code Review 微服务 服务注册发现 服务配置中心 链路跟踪 日志处理分析 EL(F)K Stack 系统服务监控 系统监控 APM服务监控 数据处理 – 大数据技术栈 多云管理 数据备份 安全 简而言之，就是通过资源、规范、服务三位一体来支撑整个企业的研发工作。</p></section><footer class=entry-footer>2020-09-09&nbsp;·&nbsp;1 min&nbsp;·&nbsp;TechNotes</footer><a class=entry-link aria-label="post link to 中小企业的研发体系" href=https://technotes.guru/posts/2020/%E4%B8%AD%E5%B0%8F%E4%BC%81%E4%B8%9A%E7%9A%84%E7%A0%94%E5%8F%91%E4%BD%93%E7%B3%BB/></a></article><article class=post-entry><header class=entry-header><h2>解决 Docker 由于node-sass build失败的问题</h2></header><section class=entry-content><p>问题描述： 在Mac上通过docker build node.js的镜像失败，由于node-sass安装失败，异常log如下
Module build failed (from ./node_modules/_sass-loader@7.1.0@sass-loader/lib/loader.js): Error: Missing binding /app/node_modules/_node-sass@4.12.0@node-sass/vendor/linux_musl-x64-57/binding.node Node Sass could not find a binding for your current environment: Linux/musl 64-bit with Node.js 8.x Found bindings for the following environments: - OS X 64-bit with Node.js 11.x This usually happens because your environment has changed since running `npm install`. Run `npm rebuild node-sass` to download the binding for your current environment. at module.exports (/app/node_modules/_node-sass@4.12.0@node-sass/lib/binding.js:15:13) at Object....</p></section><footer class=entry-footer>2019-05-05&nbsp;·&nbsp;1 min&nbsp;·&nbsp;TechNotes</footer><a class=entry-link aria-label="post link to 解决 Docker 由于node-sass build失败的问题" href=https://technotes.guru/posts/2019/%E8%A7%A3%E5%86%B3-docker-%E7%94%B1%E4%BA%8Enode-sass-build%E5%A4%B1%E8%B4%A5%E7%9A%84%E9%97%AE%E9%A2%98/></a></article><article class=post-entry><header class=entry-header><h2>解决Bert as servcie在单GPU，单线程测试场景下无响应的问题</h2></header><section class=entry-content><p>问题描述： 在一个单GPU（RTX 2080 Ti）的服务器上进行 bert as servcie 的压力测试，当使用单线程跑的时候，在JMeter连续请求1分钟左右，bert as servcie会停顿，没有响应。 但是当多个线程执行，或者在多核CPU上则无法重现。
原因： I:PROXY:[htt:enc: 48]:new request from 192.168.0.83 I:VENTILATOR:[__i:_ru:194]:new encode request req id: 17813 size: 1 client: b'e38043ad-153b-427a-b78d-d148c2032c11' I:SINK:[__i:_ru:352]:job register size: 1 job id: b'e38043ad-153b-427a-b78d-d148c2032c11#17813' I:WORKER-0:[__i:gen:553]:new job socket: 0 size: 1 client: b'e38043ad-153b-427a-b78d-d148c2032c11#17813' I:WORKER-0:[__i:_ru:528]:job done size: (1, 768) client: b'e38043ad-153b-427a-b78d-d148c2032c11#17813' I:SINK:[__i:_ru:332]:collect b'EMBEDDINGS' b'e38043ad-153b-427a-b78d-d148c2032c11#17813' (E:1/T:0/A:1) I:SINK:[__i:_ru:341]:send back size: 1 job id: b'e38043ad-153b-427a-b78d-d148c2032c11#17813' 192.168.0.83 - - [15/May/2019 03:19:37] "POST /encode HTTP/1.1" 200 - I:PROXY:[htt:enc: 48]:new request from 192....</p></section><footer class=entry-footer>2019-05-05&nbsp;·&nbsp;1 min&nbsp;·&nbsp;TechNotes</footer><a class=entry-link aria-label="post link to 解决Bert as servcie在单GPU，单线程测试场景下无响应的问题" href=https://technotes.guru/posts/2019/bert-as-servcie%E5%9C%A8%E5%8D%95gpu%E5%8D%95%E7%BA%BF%E7%A8%8B%E6%B5%8B%E8%AF%95%E5%9C%BA%E6%99%AF%E4%B8%8B%E7%B3%BB%E7%BB%9F%E5%81%9C%E9%A1%BF%E7%9A%84%E9%97%AE%E9%A2%98/></a></article><article class=post-entry><header class=entry-header><h2>代码重构 - 后端部分代码</h2></header><section class=entry-content><p>前一篇 主要写了一下前端部分的重构，这一篇则主要关注后端部分。
在前一篇后面说到了一个很实用的套路（模式），其类图如下图所示： 在后端部分，我先将后端Java代码的类图画出来： 可以发现，还是一样的套路。
代码实现 下面则具体说下实现，首先是说一下原来的系统的实现，然后是重构的实现。
原来的实现 在上一篇前端部分，拿了两个方法作为示例，在方法体的后面，则都是通过POST请求调用后端的Controller。
1 2 3 postVue("${ctx}/BusinessOpportunity/openAcct",params,function (data) {...... postVue("${ctx}/BusinessOpportunity/openAmlInviteAcct",params,function (data) {...... 这里是原有的Controller的实现： 然后则是Service的实现：
然后就是Service调用不同的MyBatis的dao层实现。
从实现上来说，就是一一相对应，优点是代码过程清晰明了，基本上完全反映实现的意图。缺点自然也很明显，比如大量重复的代码，并且也没有代码复用等。
重构过程 这部分这样描述下重构的部分。上一篇中提到了我对于重构的两个原则：
尽可能的代码复用 为使用方提供一致的调用外观 所以这一部分，还是会基于这两个主要原则，并且主要针对Controller层和Service层。
由于是前后端分离，所以这部分是Restful风格的，WEB API作为前后端的契约，一是URL尽量的符合REST语义，二是传输的数据(payload)。
这个是REST Controller的实现：
@PostMapping("/api/opportunities/batch") public ResponseEntity&lt;?> batchProcess(@RequestBody OpportunityBatchRequest request) { log.info("Process opportunity batch action - type: {}", request.getType()); List&lt;String> emailSendFailedList; try { businessOpportunityProcessorService.process(request); emailSendFailedList = businessOpportunityProcessorService.getAllEmailSendFailed(); } catch (Exception e) { log.error("Process opportunity batch action failed, type: {}, root cause: {}", request....</p></section><footer class=entry-footer>2019-02-02&nbsp;·&nbsp;2 min&nbsp;·&nbsp;TechNotes</footer><a class=entry-link aria-label="post link to 代码重构 - 后端部分代码" href=https://technotes.guru/posts/2019/refactor-the-backend/></a></article><article class=post-entry><header class=entry-header><h2>代码重构 - 前端部分代码</h2></header><section class=entry-content><p>缘起 由于工作的变动，转岗到了公司的另外一个项目里，目前的主要工作在编码方面，负责将一个原来标准的J2EE（Spring， SpringMVC，MyBatis)项目，重构成基于Restful的前后端分离的项目，后端采用Spring Boot，前端部分则采用Vue。
这里计划用两篇博客记录一下重构中的一些点，一篇为前端部分，一篇为后端部分，这篇为前端部分。 由于处在不同的职位上，所关心的内容是不同的，比如产品经理更加关心产品的功能、业务的完成度、项目经理更加关注项目的进度等，另外一方面，从代码层面来说，还是比较主观的，不同的开发人员，写出来的代码也会差别很大，所以这里仅是个人的重构记录。下面就闲话少说，“talk is cheap, show me the code”。
业务背景 这里首先交代下重构部分的业务，如下图所以，这是个比较典型的数据表格，展示了业务数据，以及相关的操作，查看详情，编辑，删除，并且可以多选，并且进行对多条数据进行批量的操作。
下图是完成了的数据表格部分，隐藏了其中涉及到的业务数据
其主要的功能为：
表格右侧的“操作”部分，主要是针对单条记录的操作，如查看，修改，删除 表格下方的批量操作部分，当选中多条记录之后，执行不同的批量操作，如批量发送邀请，批量创建账号，批量删除等。针对不同的操作，在执行相应的操作时候，需要进行不同的前端验证，如开通邀请，则需要验证所选择的记录的电话号码不能为空，邮箱不能为空，销帮帮ID是否存在，等。 代码实现 简单介绍完需求之后，逻辑并不复杂，从代码实现角度，主要就是如下几步： 1、响应按钮点击 2、在响应的方法中遍历选中的数据 3、对数据进行校验，如何校验失败，则进行相应的提示 4、将数据提交到后端
实现起来也是相当的明了。
原来的实现 这部分主要描述下上述需求的原来的实现部分，这里不会贴出全部的代码，主要还是将意图表达出来。另外，这个项目的前端展示部分是基于JSP+jQuery+Vue的，所以原来页面部分逻辑较为复杂，一部分数据是传统的基于表单的，一部分数据是jQuery Ajax方式的，一部分数据则是Vue（axios）方式。
下面的三张截图，第一张是按钮部分，针对不同的功能，对应不同的响应方法: 下面两张是其中两个方法的具体实现:
由于逻辑不复杂，所以实现上也是比较的明了。基本上完成过程式的代码实现，遍历选择的数据，对数据进行校验，然后调用后台对应的接口。
过程式的代码，优点是代码清晰明了，基本上完全反映实现的意图。缺点也比较的明显，大量的重复代码，拿贴出来的两段代码来看，基本上都是相同的，复制粘贴一个方法，然后稍微的改一改。这里不去写这些的弊端，重点还是放在重构部分的内容上。
重构过程 首先上面的代码，从功能角度来说，是可以工作的代码，但是，很多的重复代码。实际上很容易就可以发现其中可以重用的部分，如公司名称的校验，销帮帮ID的校验，邮箱的校验等。 那么，最简单的实现重用的方式，可以将其中的检验部分抽出来，形成一个一个单独的验证方法，如：
validateEmailXXX() validateCompanyNameXXX() 这样在不同的方法中，就可以重用这些验证的逻辑，原来代码中的isEmailAvailable()方法就是工具方法层面的复用。比如说常见的代码中的很多的工具类，如StringUtils，DateUtils，就是这样的一个思路，实现了一些工具方法层面的重用。(对于Ruby，Kotlin，可以非常优雅的扩展父类方法)。
不过这部分重构，我并非仅仅是抽取了几个验证的方法。下面会描述，这里先说一下我考虑的两个原则：
为使用方提供一致的调用外观 尽可能的代码复用 提供较为一致的调用外观 这部分主要是真的按钮的响应，所以这里统一了方法handleOperation的调用，然后通过type来区分。这部分看个人的习惯了，比如原来的方式，也是不错的，方法名就反映出来该方法的意图。
&lt;el-button type="primary" :disabled="totalSelectedRows === 0" @click="handleOperation('openAmlAccount')">&lt;span>开通反洗钱&lt;/span>&lt;/el-button> &lt;el-button type="primary" :disabled="totalSelectedRows === 0" @click="handleOperation('openAmlInviteAccount')">&lt;span>开通反洗钱邀请账号&lt;/span>&lt;/el-button> &lt;el-button type="danger" :disabled="totalSelectedRows === 0" @click="handleOperation('deleteOpportunities')">&lt;span>批量删除&lt;/span>&lt;/el-button> &lt;el-button type="primary" :disabled="totalSelectedRows === 0" @click="handleOperation('openNormalAccount')">&lt;span>开通账号&lt;/span>&lt;/el-button> &lt;el-button type="primary" :disabled="totalSelectedRows === 0" @click="handleOperation('openInviteAccount')">&lt;span>开通邀请账号&lt;/span>&lt;/el-button> &lt;el-button type="danger" :disabled="totalSelectedRows === 0" @click="handleOperation('physicallyDelete')">&lt;span>删除账号&lt;/span>&lt;/el-button> &lt;el-button type="danger" :disabled="totalSelectedRows === 0" @click="handleOperation('completelyPhysicalDelete')">&lt;span>彻底删除&lt;/span>&lt;/el-button> handleOperation则根据不同的type，分别调用相对于的处理方法。...</p></section><footer class=entry-footer>2019-02-02&nbsp;·&nbsp;3 min&nbsp;·&nbsp;TechNotes</footer><a class=entry-link aria-label="post link to 代码重构 - 前端部分代码" href=https://technotes.guru/posts/2019/refactor-the-frontend/></a></article><footer class=page-footer><nav class=pagination><a class=next href=https://technotes.guru/page/2/>Next Page »</a></nav></footer></main><footer class=footer><span>&copy; 2021 <a href=https://technotes.guru/>TechNotes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu')
menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>