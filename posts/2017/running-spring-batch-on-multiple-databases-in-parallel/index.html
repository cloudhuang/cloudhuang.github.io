<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Running Spring Batch on Multiple Databases in Parallel | TechNotes</title><meta name=keywords content="Java,Spring,Spring Boot"><meta name=description content="The Question I&rsquo;ve created a Spring batch application using Spring boot, and I have a Job with 9 steps. These steps are using a DataSource which I created its bean in a configuration file as follows:
@Configuration public class DatabaseConfig { @ConfigurationProperties(prefix = &#34;spring.datasource&#34;) @Bean @Primary public DataSource dataSource(){ return DataSourceBuilder.create().build(); } } This DataSource is using properties declared in the application.yml file:
spring: datasource: url: jdbc:mysql://localhost:3306/db_01?zeroDateTimeBehavior=convertToNull username: xxxx password: **** So far, all works as expected."><meta name=author content="TechNotes"><link rel=canonical href=https://technotes.guru/posts/2017/running-spring-batch-on-multiple-databases-in-parallel/><meta name=google-site-verification content="G-V4HC5K9V2M"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.min.030f3f25d9f3449b524f810ddd2c31b9d4718215f17a58bacbd906ecaf639910.css integrity="sha256-Aw8/JdnzRJtST4EN3SwxudRxghXxeli6y9kG7K9jmRA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.e85ad0406048e8176e1c7661b25d5c69297ddfe41dc4124cf75ecb99a4f7b3d1.js integrity="sha256-6FrQQGBI6BduHHZhsl1caSl93+QdxBJM917LmaT3s9E=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://technotes.guru/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://technotes.guru/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://technotes.guru/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://technotes.guru/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://technotes.guru/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.101.0"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Running Spring Batch on Multiple Databases in Parallel"><meta property="og:description" content="The Question I&rsquo;ve created a Spring batch application using Spring boot, and I have a Job with 9 steps. These steps are using a DataSource which I created its bean in a configuration file as follows:
@Configuration public class DatabaseConfig { @ConfigurationProperties(prefix = &#34;spring.datasource&#34;) @Bean @Primary public DataSource dataSource(){ return DataSourceBuilder.create().build(); } } This DataSource is using properties declared in the application.yml file:
spring: datasource: url: jdbc:mysql://localhost:3306/db_01?zeroDateTimeBehavior=convertToNull username: xxxx password: **** So far, all works as expected."><meta property="og:type" content="article"><meta property="og:url" content="https://technotes.guru/posts/2017/running-spring-batch-on-multiple-databases-in-parallel/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-06-21T00:00:00+00:00"><meta property="article:modified_time" content="2017-06-21T00:00:00+00:00"><meta property="og:site_name" content="TechNotes"><meta name=twitter:card content="summary"><meta name=twitter:title content="Running Spring Batch on Multiple Databases in Parallel"><meta name=twitter:description content="The Question I&rsquo;ve created a Spring batch application using Spring boot, and I have a Job with 9 steps. These steps are using a DataSource which I created its bean in a configuration file as follows:
@Configuration public class DatabaseConfig { @ConfigurationProperties(prefix = &#34;spring.datasource&#34;) @Bean @Primary public DataSource dataSource(){ return DataSourceBuilder.create().build(); } } This DataSource is using properties declared in the application.yml file:
spring: datasource: url: jdbc:mysql://localhost:3306/db_01?zeroDateTimeBehavior=convertToNull username: xxxx password: **** So far, all works as expected."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://technotes.guru/posts/"},{"@type":"ListItem","position":2,"name":"Running Spring Batch on Multiple Databases in Parallel","item":"https://technotes.guru/posts/2017/running-spring-batch-on-multiple-databases-in-parallel/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Running Spring Batch on Multiple Databases in Parallel","name":"Running Spring Batch on Multiple Databases in Parallel","description":"The Question I\u0026rsquo;ve created a Spring batch application using Spring boot, and I have a Job with 9 steps. These steps are using a DataSource which I created its bean in a configuration file as follows:\n@Configuration public class DatabaseConfig { @ConfigurationProperties(prefix = \u0026quot;spring.datasource\u0026quot;) @Bean @Primary public DataSource dataSource(){ return DataSourceBuilder.create().build(); } } This DataSource is using properties declared in the application.yml file:\nspring: datasource: url: jdbc:mysql://localhost:3306/db_01?zeroDateTimeBehavior=convertToNull username: xxxx password: **** So far, all works as expected.","keywords":["Java","Spring","Spring Boot"],"articleBody":"The Question I’ve created a Spring batch application using Spring boot, and I have a Job with 9 steps. These steps are using a DataSource which I created its bean in a configuration file as follows:\n@Configuration public class DatabaseConfig { @ConfigurationProperties(prefix = \"spring.datasource\") @Bean @Primary public DataSource dataSource(){ return DataSourceBuilder.create().build(); } } This DataSource is using properties declared in the application.yml file:\nspring: datasource: url: jdbc:mysql://localhost:3306/db_01?zeroDateTimeBehavior=convertToNull username: xxxx password: **** So far, all works as expected.\nWhat I want to do, is that I have 4 databases parameterized in a 5th database (db_settings), which I select using an SQL query. This query will return the 4 databases with their usernames and passwords as follows:\n+--------+-----------------------------------+-----------------+-----------------+ | id | url | username_db | password_db | +--------+-----------------------------------+-----------------+-----------------+ | 243 | jdbc:mysql://localhost:3306/db_01 | xxxx | **** | | 244 | jdbc:mysql://localhost:3306/db_02 | xxxx | **** | | 245 | jdbc:mysql://localhost:3306/db_03 | xxxx | **** | | 247 | jdbc:mysql://localhost:3306/db_04 | xxxx | **** | +--------+-----------------------------------+-----------------+-----------------+ So instead of running the steps using the database declared in ‘application.yml’, I want to run them on all the 4 databases. And considering the volume processed, it is necessary to be able to launch the batch processing on these databases in parallel.\nDoes anyone know how to implement this?\nThe Answer Thanks KeatsPeeks, AbstractRoutingDataSource is a good starter for the solution, and here is a good tutorial on this part.\nMainly the important parts are:\ndefine the lookup code public class MyRoutingDataSource extends AbstractRoutingDataSource { @Override protected Object determineCurrentLookupKey() { String language = LocaleContextHolder.getLocale().getLanguage(); System.out.println(\"Language obtained: \"+ language); return language; } } register the multiple datasources So after that, the problem is become to:\nHow to load datasource config properties when spring startup and config the corresponding dataSource using the config properties in database.\nHow to use multiple dataSource in spring batch\nActually when I try to google it, seems this is a most common case, google give the suggestion search words - “spring batch multiple data sources”, there are a lots articles, so I choose the answer in\nHow to define the lookup code based on the spring batch jobs(steps)\nTypically this should be a business point, You need define the lookup strategy and can be injected to the com.example.demo.datasource.CustomRoutingDataSource#determineCurrentLookupKey to routing to the dedicated data source.\nLimitation The really interesting is actually it is supports the multiple dataSource, but the db settings cannot store in the DB indeed. The reason is it will get the cycle dependencies issue:\nThe dependencies of some of the beans in the application context form a cycle: batchConfiguration (field private org.springframework.batch.core.configuration.annotation.JobBuilderFactory com.example.demo.batch.BatchConfiguration.jobs) ↓ org.springframework.batch.core.configuration.annotation.SimpleBatchConfiguration (field private java.util.Collection org.springframework.batch.core.configuration.annotation.AbstractBatchConfiguration.dataSources) ┌─────┐ | routingDataSource defined in class path resource [com/example/demo/datasource/DataSourceConfiguration.class] ↑ ↓ | targetDataSources defined in class path resource [com/example/demo/datasource/DataSourceConfiguration.class] ↑ ↓ | myBatchConfigurer (field private java.util.Collection org.springframework.batch.core.configuration.annotation.AbstractBatchConfiguration.dataSources) └─────┘ So obviously the solution is break the dependency between dataSource and routingDataSource, and the workaround should be:\nSave the DB setting in properties Or involve other approach but not in the primary dataSource See Also spring-data-multiple-databases hello-world-with-spring-batch-3-0-x-with-pure-annotations batch-processing How to java-configure separate datasources for spring batch data and business data? Should I even do it? ","wordCount":"538","inLanguage":"en","datePublished":"2017-06-21T00:00:00Z","dateModified":"2017-06-21T00:00:00Z","author":{"@type":"Person","name":"TechNotes"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://technotes.guru/posts/2017/running-spring-batch-on-multiple-databases-in-parallel/"},"publisher":{"@type":"Organization","name":"TechNotes","logo":{"@type":"ImageObject","url":"https://technotes.guru/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://technotes.guru/ accesskey=h title="TechNotes (Alt + H)">TechNotes</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://technotes.guru/categories/ title=categories><span>categories</span></a></li><li><a href=https://technotes.guru/tags/ title=tags><span>tags</span></a></li><li><a href=https://technotes.guru/about/ title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://technotes.guru/>Home</a>&nbsp;»&nbsp;<a href=https://technotes.guru/posts/>Posts</a></div><h1 class=post-title>Running Spring Batch on Multiple Databases in Parallel</h1><div class=post-meta>2017-06-06&nbsp;·&nbsp;3 min&nbsp;·&nbsp;TechNotes</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#the-question aria-label="The Question">The Question</a></li><li><a href=#the-answer aria-label="The Answer">The Answer</a></li><li><a href=#limitation aria-label=Limitation>Limitation</a></li><li><a href=#see-also aria-label="See Also">See Also</a></li></ul></div></details></div><div class=post-content><h2 id=the-question>The Question<a hidden class=anchor aria-hidden=true href=#the-question>#</a></h2><p>I&rsquo;ve created a Spring batch application using Spring boot, and I have a <code>Job</code> with 9 steps. These steps are using a <code>DataSource</code> which I created its bean in a configuration file as follows:</p><pre><code>@Configuration
public class DatabaseConfig {
    @ConfigurationProperties(prefix = &quot;spring.datasource&quot;)
    @Bean
    @Primary
    public DataSource dataSource(){
        return DataSourceBuilder.create().build();
    }
}
</code></pre><p>This <code>DataSource</code> is using properties declared in the <code>application.yml</code> file:</p><pre><code>spring:
  datasource:
    url: jdbc:mysql://localhost:3306/db_01?zeroDateTimeBehavior=convertToNull
    username: xxxx
    password: ****
</code></pre><p>So far, all works as expected.</p><p>What I want to do, is that I have 4 databases parameterized in a 5th database (db_settings), which I select using an SQL query. This query will return the 4 databases with their usernames and passwords as follows:</p><pre tabindex=0><code>+--------+-----------------------------------+-----------------+-----------------+
| id     | url                               | username_db     | password_db     |
+--------+-----------------------------------+-----------------+-----------------+
|    243 | jdbc:mysql://localhost:3306/db_01 | xxxx            | ****            |
|    244 | jdbc:mysql://localhost:3306/db_02 | xxxx            | ****            |
|    245 | jdbc:mysql://localhost:3306/db_03 | xxxx            | ****            |
|    247 | jdbc:mysql://localhost:3306/db_04 | xxxx            | ****            |
+--------+-----------------------------------+-----------------+-----------------+
</code></pre><p>So instead of running the steps using the database declared in &lsquo;application.yml&rsquo;, I want to run them on all the 4 databases. And considering the volume processed, it is necessary to be able to launch the batch processing on these databases in parallel.</p><p>Does anyone know how to implement this?</p><hr><h2 id=the-answer>The Answer<a hidden class=anchor aria-hidden=true href=#the-answer>#</a></h2><p>Thanks KeatsPeeks, <code>AbstractRoutingDataSource</code> is a good starter for the solution, and here is a
<a href=http://howtodoinjava.com/spring/spring-orm/spring-3-2-5-abstractroutingdatasource-example/ target=_blank>good tutorial</a> on this part.</p><p>Mainly the important parts are:</p><ol><li>define the lookup code</li></ol><pre tabindex=0><code>public class MyRoutingDataSource extends AbstractRoutingDataSource {
    @Override
    protected Object determineCurrentLookupKey() {
        String language = LocaleContextHolder.getLocale().getLanguage();
        System.out.println(&#34;Language obtained: &#34;+ language);
        return language;
    }
}
</code></pre><ol start=2><li>register the multiple datasources</li></ol><pre tabindex=0><code>&lt;bean id=&#34;abstractDataSource&#34; class=&#34;org.apache.commons.dbcp.BasicDataSource&#34;
    destroy-method=&#34;close&#34;
    p:driverClassName=&#34;${jdbc.driverClassName}&#34;
    p:username=&#34;${jdbc.username}&#34;
    p:password=&#34;${jdbc.password}&#34; /&gt;

&lt;bean id=&#34;concreteDataSourceOne&#34;
    parent=&#34;abstractDataSource&#34;
    p:url=&#34;${jdbc.databaseurlOne}&#34;/&gt;

&lt;bean id=&#34;concreteDataSourceTwo&#34;
    parent=&#34;abstractDataSource&#34;
    p:url=&#34;${jdbc.databaseurlTwo}&#34;/&gt;
</code></pre><p>So after that, the problem is become to:</p><ol><li><p>How to load datasource config properties when spring startup and config the corresponding <code>dataSource</code> using the config properties in database.</p></li><li><p>How to use multiple <code>dataSource</code> in spring batch</p><p>Actually when I try to google it, seems this is a most common case, google give the suggestion search words - &ldquo;spring batch multiple data sources&rdquo;, there are a lots articles, so I choose the answer in</p></li><li><p>How to define the lookup code based on the spring batch jobs(steps)</p><p>Typically this should be a business point, You need define the lookup strategy and can be injected to the <code>com.example.demo.datasource.CustomRoutingDataSource#determineCurrentLookupKey</code> to routing to the dedicated data source.</p></li></ol><h2 id=limitation>Limitation<a hidden class=anchor aria-hidden=true href=#limitation>#</a></h2><p>The really interesting is actually it is supports the multiple <code>dataSource</code>, but the db settings cannot store in the DB indeed. The reason is it will get the cycle dependencies issue:</p><pre tabindex=0><code>The dependencies of some of the beans in the application context form a cycle:

    batchConfiguration (field private org.springframework.batch.core.configuration.annotation.JobBuilderFactory com.example.demo.batch.BatchConfiguration.jobs)
        ↓
    org.springframework.batch.core.configuration.annotation.SimpleBatchConfiguration (field private java.util.Collection org.springframework.batch.core.configuration.annotation.AbstractBatchConfiguration.dataSources)
┌─────┐
|  routingDataSource defined in class path resource [com/example/demo/datasource/DataSourceConfiguration.class]
↑     ↓
|  targetDataSources defined in class path resource [com/example/demo/datasource/DataSourceConfiguration.class]
↑     ↓
|  myBatchConfigurer (field private java.util.Collection org.springframework.batch.core.configuration.annotation.AbstractBatchConfiguration.dataSources)
└─────┘
</code></pre><p>So obviously the solution is break the dependency between <code>dataSource</code> and <code>routingDataSource</code>, and the workaround should be:</p><ul><li>Save the DB setting in properties</li><li>Or involve other approach but not in the primary <code>dataSource</code></li></ul><h2 id=see-also>See Also<a hidden class=anchor aria-hidden=true href=#see-also>#</a></h2><ul><li><a href=https://scattercode.co.uk/2013/11/18/spring-data-multiple-databases/ target=_blank>spring-data-multiple-databases</a></li><li><a href=https://numberformat.wordpress.com/2013/12/27/hello-world-with-spring-batch-3-0-x-with-pure-annotations/ target=_blank>hello-world-with-spring-batch-3-0-x-with-pure-annotations</a></li><li><a href=http://spring.io/guides/gs/batch-processing/ target=_blank>batch-processing</a></li><li><a href=https://stackoverflow.com/questions/25256487/how-to-java-configure-separate-datasources-for-spring-batch-data-and-business-da target=_blank>How to java-configure separate datasources for spring batch data and business data? Should I even do it?</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://technotes.guru/tags/java/>Java</a></li><li><a href=https://technotes.guru/tags/spring/>Spring</a></li><li><a href=https://technotes.guru/tags/spring-boot/>Spring Boot</a></li></ul><nav class=paginav><a class=prev href=https://technotes.guru/posts/2017/why-i-hate-ant/><span class=title>« Prev Page</span><br><span>Why I hate Ant</span></a>
<a class=next href=https://technotes.guru/posts/2009/a-project-retrospection/><span class=title>Next Page »</span><br><span>一个小项目的回顾</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://technotes.guru/>TechNotes</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>